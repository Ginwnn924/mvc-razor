@model ProductListViewModel
@using mvc_razor.Models

@{
    // Helper function to render stars
    Func<decimal, string> RenderStars = (rating) =>
    {
        if (rating <= 0) return "";
        
        var fullStars = (int)Math.Floor(rating);
        var hasHalfStar = (rating - fullStars) >= 0.5m;
        var emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        
        var html = "";
        for (int i = 0; i < fullStars; i++)
        {
            html += "<i class=\"fas fa-star\"></i>";
        }
        if (hasHalfStar)
        {
            html += "<i class=\"fas fa-star-half-alt\"></i>";
        }
        for (int i = 0; i < emptyStars; i++)
        {
            html += "<i class=\"far fa-star\"></i>";
        }
        return html;
    };
    
    var productRatings = ViewBag.ProductRatings as Dictionary<int, ProductRatingInfo> ?? new Dictionary<int, ProductRatingInfo>();
}

<!-- Products Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="products">
    @if (Model.Products != null && Model.Products.Count > 0)
    {
        foreach (var product in Model.Products)
        {
            var imageUrl = !string.IsNullOrEmpty(product.ImageUrl)
                ? product.ImageUrl
                : "https://via.placeholder.com/300x200?text=" + Uri.EscapeDataString(product.ProductName);
            var stockQuantity = product.Inventory?.Quantity ?? 0;
            var isInStock = stockQuantity > 0;
            var discount = 0; // You can calculate this based on promotions if needed

            <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition transform hover:scale-105 group">
                <a href="@Url.Action("Details", new { id = product.ProductId })"
                   class="block relative bg-gray-200 h-48 overflow-hidden">
                    <img src="@imageUrl" alt="@product.ProductName"
                         class="w-full h-full object-cover group-hover:opacity-75 transition" />
                    @if (discount > 0)
                    {
                        <div class="absolute top-3 right-3 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                            -@discount%
                        </div>
                    }
                    @if (!isInStock)
                    {
                        <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                            <span class="text-white font-bold text-lg">Hết hàng</span>
                        </div>
                    }
                </a>
                <button
                    class="absolute top-3 left-3 bg-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-100 transition wishlist-btn z-10"
                    data-product-id="@product.ProductId">
                    <i class="far fa-heart text-gray-600"></i>
                </button>
                <div class="p-4">
                    <a href="@Url.Action("Details", new { id = product.ProductId })" class="block">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2 hover:text-blue-600 transition">
                            @product.ProductName
                        </h3>
                    </a>
                    @{
                        var ratingInfo = productRatings.ContainsKey(product.ProductId) 
                            ? productRatings[product.ProductId] 
                            : new ProductRatingInfo { ProductId = product.ProductId, AverageRating = 0, ReviewCount = 0 };
                        var avgRating = ratingInfo.AverageRating;
                        var reviewCount = ratingInfo.ReviewCount;
                    }
                    <div class="flex items-center mb-3">
                        @if (reviewCount > 0)
                        {
                            <div class="text-yellow-500 text-sm">
                                @Html.Raw(RenderStars(avgRating))
                            </div>
                            <span class="text-gray-600 text-sm ml-2">
                                @avgRating.ToString("F1") (@reviewCount @(reviewCount == 1 ? "review" : "reviews"))
                            </span>
                        }
                        else
                        {
                            <div class="text-gray-300 text-sm">
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                            </div>
                            <span class="text-gray-400 text-sm ml-2">Chưa có đánh giá</span>
                        }
                    </div>
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <span class="text-2xl font-bold text-blue-600">@product.Price.ToString("#,##0")đ</span>
                        </div>
                    </div>
                    <button
                        class="w-full @(isInStock ? "bg-blue-600 hover:bg-blue-700" : "bg-gray-400 cursor-not-allowed") text-white py-2 rounded-lg transition font-semibold add-to-cart-btn"
                        data-product-id="@product.ProductId"
                        data-product-name="@product.ProductName"
                        data-product-price="@product.Price"
                        @(isInStock ? "" : "disabled")>
                        <i class="fas fa-shopping-cart mr-2"></i>@(isInStock ? "Thêm vào giỏ" : "Hết sản phẩm")
                    </button>
                </div>
            </div>
        }
    }
    else
    {
        <div class="col-span-full text-center py-12">
            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-2xl font-semibold text-gray-600 mb-2">No Products Found</h3>
            <p class="text-gray-500">Please check back later or try a different search.</p>
        </div>
    }
</div>

<!-- Pagination -->
@if (Model.TotalPages > 1)
{
    <div class="flex justify-center items-center gap-2 mt-12" data-pagination-container>
        @if (Model.CurrentPage > 1)
        {
            <a href="@Url.Action("Index", new { page = Model.CurrentPage - 1 })"
               data-page-link
               data-page="@(@Model.CurrentPage - 1)"
               class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 transition">
                <i class="fas fa-chevron-left"></i>
            </a>
        }

        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            if (i == Model.CurrentPage)
            {
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg" disabled>@i</button>
            }
            else if (i >= Model.CurrentPage - 2 && i <= Model.CurrentPage + 2)
            {
                <a href="@Url.Action("Index", new { page = i })"
                   data-page-link
                   data-page="@i"
                   class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 transition">@i</a>
            }
        }

        @if (Model.CurrentPage < Model.TotalPages)
        {
            <a href="@Url.Action("Index", new { page = Model.CurrentPage + 1 })"
               data-page-link
               data-page="@(@Model.CurrentPage + 1)"
               class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 transition">
                <i class="fas fa-chevron-right"></i>
            </a>
        }
    </div>
}


